<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Personal Growth Graph üî•</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    :root { 
      --success: #10b981; 
      --danger: #ef4444; 
      --warning: #f59e0b; 
      --primary: #6366f1; 
      --secondary: #8b5cf6;
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color-scheme: light dark; 
    }

    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 0; padding: 0; 
      background: var(--bg-gradient);
      min-height: 100vh;
      color: #1f2937;
    }

    /* ========== AUTH STYLES ========== */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      color: white;
    }
    
    .auth-box {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    
    .auth-tabs {
      display: flex;
      margin-bottom: 30px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .auth-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.3s;
    }
    
    .auth-tab.active {
      color: #6366f1;
      border-bottom: 3px solid #6366f1;
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .auth-input {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 16px;
    }
    
    .auth-btn {
      width: 100%;
      padding: 15px;
      margin-top: 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3);
    }
    
    .user-info {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.95);
      padding: 10px 20px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    
    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    
    .sync-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(16,185,129,0.3);
      display: none;
      z-index: 1000;
      animation: fadeInOut 2s ease;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      15% { opacity: 1; transform: translateY(0); }
      85% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    .header { text-align: center; color: white; margin-bottom: 32px; }
    h1 { font-size: 2.2rem; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .subtitle { opacity: 0.9; margin-top: 8px; }

    /* Today Status Banner */
    .today-status {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 20px rgba(16,185,129,0.3);
      animation: fadeIn 0.4s ease;
      display: none; /* Hidden by default */
    }

    .today-status.negative {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 8px 20px rgba(239,68,68,0.3);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card { 
      background: rgba(255,255,255,0.96); 
      border-radius: 20px; 
      padding: 24px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      margin-bottom: 24px;
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
    }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { 
      background: white; 
      padding: 16px; 
      border-radius: 16px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover::before {
      transform: scaleX(1);
    }
    
    .stat-card:hover {
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .stat-value { 
      font-size: 1.8rem; 
      font-weight: 800; 
      color: #111827;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover .stat-value {
      transform: scale(1.05);
    }
    
    .stat-label { 
      font-size: 0.85rem; 
      color: #6b7280; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    .text-green { color: var(--success); }
    .text-red { color: var(--danger); }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
    }

    /* Buttons */
    button { 
      cursor: pointer; 
      padding: 10px 18px; 
      border-radius: 8px; 
      border: none;
      font-weight: 600; 
      background: var(--primary); 
      color: white;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3);
    }
    
    button:active { 
      transform: scale(0.98); 
    }
    
    button.ghost { 
      background: transparent; 
      color: #4b5563; 
      border: 1px solid #d1d5db;
    }
    
    button.ghost:hover { 
      background: #f3f4f6; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    button.warn { 
      background: var(--danger); 
    }
    
    button.warn:hover {
      box-shadow: 0 6px 12px rgba(239, 68, 68, 0.3);
    }
    
    button.small { 
      padding: 6px 12px; 
      font-size: 0.85rem; 
    }
    
    button.success {
      background: var(--success);
    }
    
    button.success:hover {
      box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    }

    /* Table */
    .table-responsive { 
      overflow-x: auto; 
      max-height: 400px; 
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 600px; 
    }
    
    th { 
      text-align: left; 
      padding: 12px; 
      color: #6b7280; 
      border-bottom: 2px solid #e5e7eb; 
      position: sticky; 
      top: 0; 
      background: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }
    
    td { 
      padding: 12px; 
      border-bottom: 1px solid #f3f4f6; 
      transition: background-color 0.2s;
    }
    
    tr:hover td {
      background-color: #f9fafb;
    }
    
    tr.penalty-row { 
      background-color: #fef2f2; 
    }
    
    tr.penalty-row td { 
      color: #991b1b; 
    }

    .badge { 
      padding: 4px 10px; 
      border-radius: 20px; 
      font-size: 0.8rem; 
      font-weight: bold;
      display: inline-block;
      transition: transform 0.2s;
    }
    
    .badge:hover {
      transform: scale(1.05);
    }
    
    .badge-green { 
      background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
      color: #065f46; 
      border: 1px solid #10b981;
    }
    
    .badge-red { 
      background: linear-gradient(135deg, #fee2e2, #fecaca); 
      color: #991b1b; 
      border: 1px solid #ef4444;
    }
    
    .badge-auto { 
      background: linear-gradient(135deg, #ffedd5, #fed7aa); 
      color: #9a3412; 
      border: 1px solid #fdba74;
    }

    /* Modals */
    .modal-overlay {
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.6); 
      backdrop-filter: blur(4px);
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 100;
    }
    
    .modal {
      background: white; 
      padding: 30px; 
      border-radius: 24px; 
      width: 90%; 
      max-width: 400px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    
    @keyframes popIn { 
      from { 
        opacity: 0; 
        transform: scale(0.95) translateY(10px); 
      } 
      to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
      } 
    }

    input[type="number"], input[type="text"] {
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e5e7eb; 
      border-radius: 10px;
      font-size: 1.2rem; 
      font-weight: bold; 
      margin: 10px 0; 
      outline: none;
      transition: all 0.3s;
    }
    
    input:focus { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .range-info {
      font-size: 0.8rem; 
      color: #6b7280; 
      margin-top: 5px; 
      text-align: center;
    }

    /* Progress Bar */
    .progress-container {
      width: 100%;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 3px;
      width: 0%;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Achievement Badges */
    .badge-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
      justify-content: center;
    }
    
    .achievement-badge {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #78350f;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    @media (max-width: 600px) {
      table { min-width: 100%; }
      .today-status { padding: 15px; }
      .today-status > div:first-child { flex: 1; }
      #todayStatusEmoji { font-size: 2.5rem; }
      .chart-container { height: 250px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .user-info {
        top: 10px;
        right: 10px;
        left: 10px;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>

<!-- ========== LOGIN/SIGNUP SCREEN ========== -->
<div id="authContainer" class="auth-container">
  <div class="auth-box">
    <h1 style="text-align: center; color: #1f2937; margin-bottom: 30px;">
      <span style="font-size: 2.5rem;">üöÄ</span><br>
      Personal Growth Graph
    </h1>
    
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="showAuthTab('login')">Login</div>
      <div class="auth-tab" onclick="showAuthTab('signup')">Sign Up</div>
    </div>
    
    <div id="loginForm" class="auth-form active">
      <input type="email" id="loginEmail" class="auth-input" placeholder="Email" required>
      <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
      <button onclick="loginUser()" class="auth-btn">Login</button>
      <p style="text-align: center; margin-top: 20px; color: #6b7280; font-size: 0.9rem;">
        New user? <a href="#" onclick="showAuthTab('signup')" style="color: #6366f1; font-weight: 600;">Sign up here</a>
      </p>
      <p style="text-align: center; margin-top: 10px; color: #6b7280; font-size: 0.8rem;">
        <a href="#" onclick="resetPassword()" style="color: #6366f1;">Forgot Password?</a>
      </p>
    </div>
    
    <div id="signupForm" class="auth-form">
      <input type="text" id="signupName" class="auth-input" placeholder="Full Name" required>
      <input type="email" id="signupEmail" class="auth-input" placeholder="Email" required>
      <input type="password" id="signupPassword" class="auth-input" placeholder="Password (minimum 6 characters)" required>
      <button onclick="signupUser()" class="auth-btn">Create Account</button>
      <p style="text-align: center; margin-top: 20px; color: #6b7280; font-size: 0.9rem;">
        Already have an account? <a href="#" onclick="showAuthTab('login')" style="color: #6366f1; font-weight: 600;">Login here</a>
      </p>
    </div>
    
    <div id="authMessage" style="text-align: center; margin-top: 20px; padding: 10px; border-radius: 8px;"></div>
  </div>
</div>

<!-- ========== MAIN APP (Hidden until login) ========== -->
<div id="appContainer" style="display: none;">
  <!-- User Info Bar -->
  <div class="user-info">
    <div class="user-avatar" id="userAvatar">U</div>
    <div>
      <div id="userName" style="font-weight: 600;"></div>
      <div id="userEmail" style="font-size: 12px; color: #6b7280;"></div>
    </div>
    <button onclick="logoutUser()" class="logout-btn">Logout</button>
  </div>
  
  <!-- Sync Status Indicator -->
  <div class="sync-status" id="syncStatus">üîÑ Syncing...</div>
  
  <!-- Original App Content -->
  <div class="container">
    <!-- Today Status Banner -->
    <div id="todayStatusBanner" class="today-status" style="display:none;">
      <div>
        <div style="font-weight:700; opacity:0.9; font-size: 0.9rem;">AAJ KA DIN</div>
        <div id="todayStatusText" style="font-size:1.5rem; font-weight:800; margin-top: 4px;"></div>
        <div id="todayStatusSubtext" style="font-size:0.9rem; opacity:0.8; margin-top: 4px;"></div>
      </div>
      <div id="todayStatusEmoji" style="font-size:3rem;">üî•</div>
    </div>

    <div class="header">
      <h1>üöÄ Personal Growth Graph</h1>
      <p class="subtitle" id="motivationalQuote">Consistency is Key</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="dispCurrent">0</div>
        <div class="stat-label">Current Value</div>
        <div class="progress-container">
          <div class="progress-bar" id="currentProgress"></div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="dispGrowth">0</div>
        <div class="stat-label">Net Growth</div>
        <div class="progress-container">
          <div class="progress-bar" id="growthProgress"></div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="dispDays">0</div>
        <div class="stat-label">Days Tracked</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="dispAvgGrowth">0</div>
        <div class="stat-label">Avg Daily Growth</div>
        <div class="badge-container" id="achievementBadges"></div>
      </div>
    </div>

    <!-- Main Chart -->
    <div class="card">
      <div class="chart-container">
        <canvas id="mainChart"></canvas>
      </div>
      <div style="text-align: center; margin-top: 15px; color: #6b7280; font-size: 0.9rem;">
        <span id="chartInfo">Hover over points for details</span>
      </div>
    </div>

    <!-- Settings & Data -->
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap:10px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <label style="font-weight: 600;">Starting Base:</label>
          <input type="number" id="baseInput" value="16" style="width: 90px; padding: 6px; margin:0; font-size: 1rem;">
          <button onclick="saveBaseSettings()" class="ghost small">Update</button>
        </div>
        <div>
          <button onclick="exportData()" class="ghost small">‚¨á Export</button>
          <button onclick="document.getElementById('importFile').click()" class="ghost small">‚¨Ü Import</button>
          <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(this)">
          <button onclick="resetAll()" class="warn small">Reset</button>
        </div>
      </div>

      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Growth</th>
              <th>Total</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Daily Entry Modal -->
<div class="modal-overlay" id="dailyModal">
  <div class="modal">
    <h2>Aaj ka din kaisa raha? ü§î</h2>
    <p style="color: #6b7280; margin-bottom: 15px;">
      Aaj ke points enter karein. <br>
      <small style="color: var(--danger)">*Skip karne par -1 auto-penalty lagegi.*</small>
    </p>
    <input type="text" id="dailyInput" placeholder="-5 se +5 tak" autofocus>
    <div class="range-info">Range: -5 to +5</div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button onclick="submitDaily()" style="flex: 1;" class="success">Save Entry</button>
    </div>
    <button onclick="skipDaily()" class="ghost" style="width: 100%; margin-top: 10px; border: none;">Skip (-1 Point)</button>
  </div>
</div>

<!-- Edit Entry Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>Edit Entry ‚úèÔ∏è</h2>
    <p id="editDateDisplay" style="color: #6b7280; font-weight: 600;"></p>
    <input type="text" id="editInput">
    <div class="range-info">Range: -5 to +5</div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
      <button onclick="saveEdit()" style="flex: 1;">Update</button>
      <button onclick="closeEdit()" class="ghost">Cancel</button>
    </div>
  </div>
</div>

<script>
  // ================= FIREBASE CONFIGURATION =================
  const firebaseConfig = {
    apiKey: "AIzaSyDcUGX0r8EmQkM-1w4APwKHDL-TdMNiwUs",
    authDomain: "personalgrowthgraph.firebaseapp.com",
    projectId: "personalgrowthgraph",
    storageBucket: "personalgrowthgraph.firebasestorage.app",
    messagingSenderId: "867503493600",
    appId: "1:867503493600:web:491bd96cc2a7bac6769b85",
    measurementId: "G-ER5NBJXBK3"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ================= AUTH FUNCTIONS =================
  function showAuthTab(tabName) {
    // Update tabs
    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.auth-form').forEach(form => {
      form.classList.remove('active');
    });
    
    // Activate selected tab
    document.querySelector(`.auth-tab[onclick*="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}Form`).classList.add('active');
    
    // Clear messages
    document.getElementById('authMessage').innerHTML = '';
  }

  async function signupUser() {
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    
    if (!name || !email || !password) {
      showAuthMessage('Please fill all fields', 'error');
      return;
    }
    
    if (password.length < 6) {
      showAuthMessage('Password must be at least 6 characters', 'error');
      return;
    }
    
    try {
      showAuthMessage('Creating account...', 'info');
      
      // Create user with Firebase Auth
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;
      
      // Save user profile to Firestore
      await db.collection('users').doc(user.uid).set({
        name: name,
        email: email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Initialize user's growth data
      await initializeUserData(user.uid);
      
      showAuthMessage('Account created successfully! Loading your data...', 'success');
      
      // Load app after a short delay
      setTimeout(() => {
        loadApp(user);
      }, 1500);
      
    } catch (error) {
      let errorMessage = 'Error creating account. ';
      switch (error.code) {
        case 'auth/email-already-in-use':
          errorMessage += 'Email already registered.';
          break;
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        case 'auth/weak-password':
          errorMessage += 'Password is too weak.';
          break;
        default:
          errorMessage += error.message;
      }
      showAuthMessage(errorMessage, 'error');
    }
  }

  async function loginUser() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
      showAuthMessage('Please enter email and password', 'error');
      return;
    }
    
    try {
      showAuthMessage('Logging in...', 'info');
      
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;
      
      // Update last login time
      await db.collection('users').doc(user.uid).update({
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      showAuthMessage('Login successful! Loading your data...', 'success');
      
      setTimeout(() => {
        loadApp(user);
      }, 1000);
      
    } catch (error) {
      let errorMessage = 'Login failed. ';
      switch (error.code) {
        case 'auth/user-not-found':
          errorMessage += 'No account found with this email.';
          break;
        case 'auth/wrong-password':
          errorMessage += 'Incorrect password.';
          break;
        case 'auth/invalid-email':
          errorMessage += 'Invalid email address.';
          break;
        default:
          errorMessage += error.message;
      }
      showAuthMessage(errorMessage, 'error');
    }
  }

  async function resetPassword() {
    const email = prompt('Please enter your email address to reset password:');
    if (!email) return;
    
    try {
      await auth.sendPasswordResetEmail(email);
      showAuthMessage('Password reset email sent! Check your inbox.', 'success');
    } catch (error) {
      showAuthMessage('Error sending reset email: ' + error.message, 'error');
    }
  }

  async function logoutUser() {
    if (confirm('Logout from all devices?')) {
      try {
        await auth.signOut();
        showSyncStatus('Logged out successfully');
        setTimeout(() => {
          location.reload();
        }, 1000);
      } catch (error) {
        console.error('Logout error:', error);
      }
    }
  }

  function showAuthMessage(message, type = 'info') {
    const msgDiv = document.getElementById('authMessage');
    msgDiv.innerHTML = message;
    
    switch (type) {
      case 'error':
        msgDiv.style.color = '#ef4444';
        msgDiv.style.backgroundColor = '#fef2f2';
        msgDiv.style.border = '1px solid #fecaca';
        break;
      case 'success':
        msgDiv.style.color = '#10b981';
        msgDiv.style.backgroundColor = '#ecfdf5';
        msgDiv.style.border = '1px solid #a7f3d0';
        break;
      default:
        msgDiv.style.color = '#6366f1';
        msgDiv.style.backgroundColor = '#eef2ff';
        msgDiv.style.border = '1px solid #c7d2fe';
    }
  }

  // ================= USER DATA MANAGEMENT =================
  let currentUserId = null;
  let unsubscribeSnapshot = null;

  async function initializeUserData(uid) {
    const initialData = {
      baseValue: 16,
      entries: [],
      streakData: { count: 0, lastDate: "" },
      milestones: { "5": false, "10": false, "20": false, "50": false },
      settings: {},
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection('userData').doc(uid).set(initialData);
    return initialData;
  }

  async function loadUserData(uid) {
    try {
      const docRef = db.collection('userData').doc(uid);
      const docSnap = await docRef.get();
      
      if (docSnap.exists) {
        return docSnap.data();
      } else {
        // Initialize data if doesn't exist
        return await initializeUserData(uid);
      }
    } catch (error) {
      console.error('Error loading user data:', error);
      return null;
    }
  }

  async function saveUserData(dataToSave) {
    if (!currentUserId) return;
    
    try {
      dataToSave.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('userData').doc(currentUserId).set(dataToSave, { merge: true });
      showSyncStatus('‚úÖ Data saved to cloud');
    } catch (error) {
      console.error('Error saving data:', error);
      showSyncStatus('‚ùå Sync failed');
    }
  }

  function showSyncStatus(message) {
    const status = document.getElementById('syncStatus');
    status.textContent = message;
    status.style.display = 'block';
    
    // Auto-hide after 2 seconds
    setTimeout(() => {
      status.style.display = 'none';
    }, 2000);
  }

  // ================= REALTIME SYNC =================
  function setupRealtimeSync(uid) {
    // Clean up previous listener if exists
    if (unsubscribeSnapshot) {
      unsubscribeSnapshot();
    }
    
    const docRef = db.collection('userData').doc(uid);
    
    // Listen for real-time updates
    unsubscribeSnapshot = docRef.onSnapshot((doc) => {
      if (doc.exists) {
        const remoteData = doc.data();
        
        // Check if data is different from current local data
        const localDataStr = JSON.stringify({
          baseValue: baseValue,
          entries: entries,
          streakData: streakData,
          milestones: milestones
        });
        
        const remoteDataStr = JSON.stringify({
          baseValue: remoteData.baseValue || 16,
          entries: remoteData.entries || [],
          streakData: remoteData.streakData || { count: 0, lastDate: "" },
          milestones: remoteData.milestones || { "5": false, "10": false, "20": false, "50": false }
        });
        
        if (localDataStr !== remoteDataStr) {
          showSyncStatus('üîÑ Syncing from cloud...');
          
          // Update local data from cloud
          baseValue = remoteData.baseValue || 16;
          entries = remoteData.entries || [];
          streakData = remoteData.streakData || { count: 0, lastDate: "" };
          milestones = remoteData.milestones || { "5": false, "10": false, "20": false, "50": false };
          
          // Update UI
          document.getElementById('baseInput').value = baseValue;
          render();
          updateTodayBanner();
        }
      }
    }, (error) => {
      console.error('Sync error:', error);
      showSyncStatus('‚ùå Sync error');
    });
    
    // Auto-save every 30 seconds
    setInterval(() => {
      if (currentUserId && entries.length > 0) {
        const data = {
          baseValue: baseValue,
          entries: entries,
          streakData: streakData,
          milestones: milestones
        };
        saveUserData(data);
      }
    }, 30000);
  }

  // ================= LOAD APP =================
  async function loadApp(user) {
    currentUserId = user.uid;
    
    // Hide auth, show app
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    
    try {
      // Load user profile
      const userDoc = await db.collection('users').doc(user.uid).get();
      const userData = userDoc.data();
      
      // Update user info display
      document.getElementById('userName').textContent = userData.name || 'User';
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('userAvatar').textContent = (userData.name || 'U').charAt(0).toUpperCase();
      
      // Load user's growth data
      const growthData = await loadUserData(user.uid);
      
      if (growthData) {
        baseValue = growthData.baseValue || 16;
        entries = growthData.entries || [];
        streakData = growthData.streakData || { count: 0, lastDate: "" };
        milestones = growthData.milestones || { "5": false, "10": false, "20": false, "50": false };
      }
      
      // Setup real-time sync
      setupRealtimeSync(user.uid);
      
      // Initialize the app
      init();
      showSyncStatus(`Welcome ${userData.name || 'User'}!`);
      
    } catch (error) {
      console.error('Error loading app:', error);
      showAuthMessage('Error loading data. Please try again.', 'error');
      auth.signOut();
    }
  }

  // ================= ORIGINAL APP CODE (Modified for Firebase) =================
  // Utilities
  const toYMD = (d) => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  };
  
  const todayYMD = () => toYMD(new Date());
  
  const parseYMD = (s) => {
    const [y, m, d] = s.split('-').map(Number);
    const dt = new Date();
    dt.setHours(0,0,0,0);
    dt.setFullYear(y, m - 1, d);
    return dt;
  };
  
  const addDays = (date, days) => {
    const d = new Date(date.getTime());
    d.setDate(d.getDate() + days);
    d.setHours(0,0,0,0);
    return d;
  };
  
  const formatShort = (s) => {
    const d = parseYMD(s);
    return d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
  };
  
  const daysBetween = (date1, date2) => {
    const diffTime = Math.abs(date2 - date1);
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  };

  // Input Validation
  function clampValue(value) {
    return Math.max(-5, Math.min(5, value));
  }

  function parseInputValue(inputStr) {
    if (!inputStr || inputStr === '-' || inputStr === '') {
      return 0;
    }
    
    const cleaned = inputStr.replace(/[^0-9.\-]/g, '');
    const num = parseFloat(cleaned);
    
    if (isNaN(num)) {
      return 0;
    }
    
    return clampValue(num);
  }

  function formatInputValue(value) {
    if (value === 0) {
      return '-';
    }
    return value.toString();
  }

  // Celebration Functions
  function createConfetti() {
    const colors = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
    
    for (let i = 0; i < 150; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      
      const color = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.backgroundColor = color;
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.top = '-10px';
      confetti.style.width = Math.random() * 10 + 5 + 'px';
      confetti.style.height = Math.random() * 10 + 5 + 'px';
      confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      
      document.body.appendChild(confetti);
      
      const animation = confetti.animate([
        { 
          transform: `translate(0, 0) rotate(0deg)`,
          opacity: 1 
        },
        { 
          transform: `translate(${Math.random() * 200 - 100}px, 100vh) rotate(${Math.random() * 720}deg)`,
          opacity: 0 
        }
      ], {
        duration: Math.random() * 3000 + 2000,
        easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
      });
      
      animation.onfinish = () => confetti.remove();
    }
  }

  // Motivational Messages
  const motivationalMessages = [
    "Consistency is Key! üîë",
    "Every small step counts! üë£",
    "Keep pushing forward! üí™",
    "Growth is a journey, not a destination! üöó",
    "You're doing great! üåü",
    "Progress, not perfection! üìà",
    "Stay committed to your growth! üå±",
    "Your future self will thank you! üôè",
    "Small improvements add up! üéØ",
    "Keep the momentum going! ‚ö°"
  ];
  
  const dailyMessages = {
    positive: [
      "Amazing work today! üéâ",
      "You're on fire! üî•",
      "Incredible progress! üöÄ",
      "Keep it up! üëç",
      "You're unstoppable! üí•"
    ],
    negative: [
      "Tomorrow is a new day! üåÖ",
      "Learn and move forward! üìö",
      "Setback is setup for comeback! üí™",
      "Keep going, you got this! üôå",
      "Progress isn't always linear! üìâ‚û°üìà"
    ]
  };

  // State Variables
  let baseValue = 16;
  let entries = [];
  let streakData = { count: 0, lastDate: "" };
  let milestones = { "5": false, "10": false, "20": false, "50": false };
  let chartInstance = null;
  let editingDate = null;
  let bannerTimeout = null;

  // Today Status Banner
  function updateTodayBanner() {
    const today = todayYMD();
    const todayEntry = entries.find(e => e.date === today);
    const banner = document.getElementById('todayStatusBanner');
    const statusText = document.getElementById('todayStatusText');
    const statusSubtext = document.getElementById('todayStatusSubtext');
    const statusEmoji = document.getElementById('todayStatusEmoji');

    if (bannerTimeout) {
      clearTimeout(bannerTimeout);
      bannerTimeout = null;
    }

    if (!todayEntry) {
      banner.style.display = 'none';
      return;
    }

    banner.style.display = 'flex';
    const val = todayEntry.val;

    if (val >= 0) {
      banner.className = 'today-status';
      statusText.innerText = `+${val} Points Gained!`;
      const randomMsg = dailyMessages.positive[Math.floor(Math.random() * dailyMessages.positive.length)];
      statusSubtext.innerText = randomMsg;
      statusEmoji.innerText = val > 1 ? 'üöÄ' : (val === 1 ? 'üî•' : 'üëç');
      
      if (val >= 3) {
        createConfetti();
      }
    } else {
      banner.className = 'today-status negative';
      statusText.innerText = `${val} Points (Degrowth)`;
      const randomMsg = dailyMessages.negative[Math.floor(Math.random() * dailyMessages.negative.length)];
      statusSubtext.innerText = randomMsg;
      statusEmoji.innerText = 'üìâ';
    }

    bannerTimeout = setTimeout(() => {
      banner.style.display = 'none';
    }, 3400);
  }

  // Streak Calculation
  function calculateStreak() {
    if (!entries || entries.length === 0) {
      streakData = { count: 0, lastDate: "" };
      return;
    }

    entries.sort((a, b) => parseYMD(a.date) - parseYMD(b.date));

    let streak = 0;
    let prevDate = null;

    for (let i = entries.length - 1; i >= 0; i--) {
      const entry = entries[i];
      const entryDate = parseYMD(entry.date);

      if (entry.type !== 'manual' || entry.val < 0) {
        break;
      }

      if (!prevDate) {
        streak = 1;
        prevDate = entryDate;
        continue;
      }

      const diff = daysBetween(entryDate, prevDate);
      if (diff === 1) {
        streak++;
        prevDate = entryDate;
      } else {
        break;
      }
    }

    streakData.count = streak;
    streakData.lastDate = streak > 0 ? toYMD(prevDate) : "";
  }

  // Core Functions
  function init() {
    document.getElementById('baseInput').value = baseValue;
    
    const randomIndex = Math.floor(Math.random() * motivationalMessages.length);
    document.getElementById('motivationalQuote').textContent = motivationalMessages[randomIndex];

    if (!entries || entries.length === 0) {
      entries = [];
      render();
      setTimeout(() => {
        openDailyModal();
      }, 500);
      return;
    }

    processMissedDays();
    calculateStreak();
    checkTodayPrompt();
    render();
    updateTodayBanner();
    checkMilestones();
  }

  function openDailyModal() {
    const modal = document.getElementById('dailyModal');
    modal.style.display = 'flex';
    
    const input = document.getElementById('dailyInput');
    input.value = '-';
    
    setTimeout(() => {
      input.focus();
      input.setSelectionRange(0, input.value.length);
    }, 0);
  }

  function processMissedDays() {
    if (!entries || entries.length === 0) return;

    entries.sort((a, b) => parseYMD(a.date) - parseYMD(b.date));

    const last = parseYMD(entries[entries.length - 1].date);
    const today = parseYMD(todayYMD());
    let curr = addDays(last, 1);

    let changed = false;
    while (curr < today) {
      const ds = toYMD(curr);
      if (!entries.find(e => e.date === ds)) {
        entries.push({ date: ds, val: -1, type: 'auto' });
        changed = true;
      }
      curr = addDays(curr, 1);
    }

    if (changed) {
      saveDataToCloud();
    }
  }

  function checkTodayPrompt() {
    const today = todayYMD();
    const hasToday = entries.some(e => e.date === today);
    if (!hasToday) {
      setTimeout(() => {
        openDailyModal();
      }, 1000);
    }
  }

  function submitDaily() {
    const inputStr = document.getElementById('dailyInput').value;
    const v = parseInputValue(inputStr);
    
    const clampedValue = clampValue(v);
    
    if (Math.abs(v) > 5) {
      alert(`Value clamped to ${clampedValue} (range is -5 to +5)`);
    }
    
    addEntry(todayYMD(), clampedValue, 'manual');
    document.getElementById('dailyModal').style.display = 'none';
    document.getElementById('dailyInput').value = '';
  }

  function skipDaily() {
    if (confirm("Are you sure? This will add -1 for today.")) {
      addEntry(todayYMD(), -1, 'skipped');
      document.getElementById('dailyModal').style.display = 'none';
      document.getElementById('dailyInput').value = '';
    }
  }

  // Milestone Check
  function checkMilestones() {
    const current = entries.reduce((sum, entry) => sum + entry.val, baseValue);
    const netGrowth = current - baseValue;
    
    const milestonePoints = [5, 10, 20, 50];
    
    milestonePoints.forEach(point => {
      if (netGrowth >= point && !milestones[point]) {
        milestones[point] = true;
        
        // Celebrate milestone
        setTimeout(() => {
          alert(`üéâ Congratulations! You've reached +${point} net growth! üéâ`);
          createConfetti();
        }, 1000);
        
        // Save to cloud
        saveDataToCloud();
      }
    });
  }

  // Edit / CRUD Functions
  function addEntry(date, val, type) {
    entries = entries.filter(e => e.date !== date);
    entries.push({ date, val, type });
    saveDataToCloud();
    calculateStreak();
    render();
    
    if (date === todayYMD()) {
      setTimeout(() => {
        updateTodayBanner();
      }, 300);
    }
    
    checkMilestones();
  }

  function deleteEntry(date) {
    if (confirm('Delete this entry?')) {
      entries = entries.filter(e => e.date !== date);
      saveDataToCloud();
      calculateStreak();
      render();
      
      if (date === todayYMD()) {
        document.getElementById('todayStatusBanner').style.display = 'none';
        checkTodayPrompt();
      }
    }
  }

  window.openEdit = function(date) {
    const entry = entries.find(e => e.date === date);
    if (!entry) return;
    editingDate = date;
    document.getElementById('editDateDisplay').innerText = `Date: ${date}`;
    
    document.getElementById('editInput').value = formatInputValue(entry.val);
    
    document.getElementById('editModal').style.display = 'flex';
    setTimeout(() => {
      const input = document.getElementById('editInput');
      input.focus();
      input.setSelectionRange(0, input.value.length);
    }, 0);
  };

  function saveEdit() {
    const inputStr = document.getElementById('editInput').value;
    const val = parseInputValue(inputStr);
    
    const clampedValue = clampValue(val);
    
    if (Math.abs(val) > 5) {
      alert(`Value clamped to ${clampedValue} (range is -5 to +5)`);
    }
    
    const idx = entries.findIndex(e => e.date === editingDate);
    if (idx > -1) {
      entries[idx].val = clampedValue;
      entries[idx].type = 'manual';
      saveDataToCloud();
      calculateStreak();
      render();
      
      if (editingDate === todayYMD()) {
        setTimeout(() => {
          updateTodayBanner();
        }, 300);
      }
    }
    closeEdit();
  }

  function closeEdit() {
    document.getElementById('editModal').style.display = 'none';
    editingDate = null;
  }

  // Save Data to Cloud
  function saveDataToCloud() {
    if (!currentUserId) return;
    
    const data = {
      baseValue: baseValue,
      entries: entries,
      streakData: streakData,
      milestones: milestones,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    saveUserData(data);
  }

  function saveBaseSettings() {
    baseValue = parseFloat(document.getElementById('baseInput').value) || 16;
    saveDataToCloud();
    render();
  }

  // Render Function
  function render() {
    entries.sort((a, b) => parseYMD(a.date) - parseYMD(b.date));
    calculateStreak();

    let current = baseValue;
    const tableData = entries.map(e => {
      current += e.val;
      return { ...e, total: parseFloat(current.toFixed(2)) };
    });

    // Update Stats
    const netGrowth = current - baseValue;
    const currentElem = document.getElementById('dispCurrent');
    const growthElem = document.getElementById('dispGrowth');
    
    currentElem.innerText = current.toFixed(2);
    growthElem.innerHTML = (netGrowth >= 0 ? '+' : '') + netGrowth.toFixed(2);
    growthElem.className = 'stat-value ' + (netGrowth >= 0 ? 'text-green' : 'text-red');
    
    document.getElementById('dispDays').innerText = entries.length;

    // Calculate Average Daily Growth
    const currentVal = tableData.length ? tableData[tableData.length - 1].total : baseValue;
    const totalGrowth = currentVal - baseValue;
    const days = entries.length;
    const avgGrowth = days > 0 ? (totalGrowth / days) : 0;
    
    const avgGrowthElem = document.getElementById('dispAvgGrowth');
    avgGrowthElem.innerHTML = (avgGrowth >= 0 ? '+' : '') + avgGrowth.toFixed(2);
    avgGrowthElem.className = 'stat-value ' + (avgGrowth >= 0 ? 'text-green' : 'text-red');

    // Update Progress Bars
    const currentProgress = document.getElementById('currentProgress');
    const growthProgress = document.getElementById('growthProgress');
    
    setTimeout(() => {
      const currentTargetWidth = Math.min(100, (current / (baseValue * 2)) * 100);
      const growthTargetWidth = Math.min(100, Math.max(0, 50 + (netGrowth / baseValue) * 50));
      
      currentProgress.style.width = currentTargetWidth + '%';
      growthProgress.style.width = growthTargetWidth + '%';
    }, 100);

    // Update Achievement Badges
    const badgeContainer = document.getElementById('achievementBadges');
    badgeContainer.innerHTML = '';

    if (streakData.count > 0) {
      const streakBadge = document.createElement('div');
      streakBadge.className = 'achievement-badge';
      streakBadge.innerHTML = `üî• ${streakData.count}-Day Streak`;
      badgeContainer.appendChild(streakBadge);
    }

    // Render Table
    const tbody = document.getElementById('logTable');
    tbody.innerHTML = '';
    
    [...tableData].reverse().forEach((row, index) => {
      const isPos = row.val >= 0;
      const isAuto = row.type === 'auto' || row.type === 'skipped';
      const badgeClass = isAuto ? 'badge-auto' : (isPos ? 'badge-green' : 'badge-red');
      const badgeText = isAuto ? (row.type === 'skipped' ? 'Skipped (-1)' : 'Auto (-1)') : (isPos ? `+${row.val}` : row.val);

      const tr = document.createElement('tr');
      if (isAuto) tr.classList.add('penalty-row');
      
      tr.style.animationDelay = `${index * 0.05}s`;

      tr.innerHTML = `
        <td>${row.date}</td>
        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
        <td style="font-weight:bold">${row.total}</td>
        <td style="font-size:0.85rem; color:#6b7280;">${row.type || 'manual'}</td>
        <td>
          <button class="ghost small" onclick="openEdit('${row.date}')">Edit</button>
          <button class="ghost small" onclick="deleteEntry('${row.date}')" style="color:#ef4444; border-color:#fee2e2;">√ó</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    renderChart(tableData);
  }

  function renderChart(data) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
    gradient.addColorStop(1, 'rgba(99, 102, 241, 0.05)');

    const labels = data.map(d => formatShort(d.date));
    const values = data.map(d => d.total);
    
    const minValue = Math.min(...values, baseValue) * 0.95;
    const maxValue = Math.max(...values, baseValue) * 1.05;

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Growth Value',
            data: values,
            borderColor: '#6366f1',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#6366f1',
            pointBorderWidth: 2,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#ffffff',
            pointHoverBorderColor: '#6366f1',
            pointHoverBorderWidth: 3
          },
          {
            label: 'Starting Base',
            data: Array(values.length).fill(baseValue),
            borderColor: '#9ca3af',
            borderWidth: 1,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0,
            tension: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#111827',
            bodyColor: '#374151',
            borderColor: '#6366f1',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toFixed(2);
                }
                return label;
              },
              afterLabel: function(context) {
                if (context.datasetIndex === 0 && data[context.dataIndex]) {
                  const entry = data[context.dataIndex];
                  const dailyChange = entry.val;
                  return `Daily: ${dailyChange >= 0 ? '+' : ''}${dailyChange}`;
                }
                return '';
              }
            }
          }
        },
        scales: {
          y: { 
            grid: { 
              color: 'rgba(0, 0, 0, 0.05)',
              drawBorder: false
            },
            ticks: {
              color: '#6b7280',
              font: { size: 12 },
              callback: function(value) {
                return value.toFixed(1);
              }
            },
            min: minValue,
            max: maxValue
          },
          x: { 
            grid: { 
              display: false,
              drawBorder: false
            },
            ticks: {
              color: '#6b7280',
              font: { size: 11 },
              maxRotation: 45
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        elements: {
          line: {
            tension: 0.4
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
    
    // Update chart info
    const chartInfo = document.getElementById('chartInfo');
    if (data.length > 0) {
      const firstDate = formatShort(data[0].date);
      const lastDate = formatShort(data[data.length - 1].date);
      chartInfo.textContent = `Tracking from ${firstDate} to ${lastDate} ‚Ä¢ ${data.length} days ‚Ä¢ Streak: ${streakData.count}`;
    } else {
      chartInfo.textContent = 'No data yet. Add your first entry!';
    }
  }

  // Import/Export/Reset
  function exportData() {
    const dataStr = JSON.stringify({ 
      base: baseValue, 
      entries,
      streak: streakData,
      milestones: milestones
    });
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `growth_data_${todayYMD()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showSyncStatus('‚úÖ Data exported');
  }

  function importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const d = JSON.parse(e.target.result);
        entries = Array.isArray(d.entries) ? d.entries : [];
        baseValue = typeof d.base === 'number' ? d.base : 16;
        streakData = d.streak || { count: 0, lastDate: "" };
        milestones = d.milestones || {"5": false, "10": false, "20": false, "50": false};
        
        saveDataToCloud();
        init();
        updateTodayBanner();
        createConfetti();
        showSyncStatus('‚úÖ Data imported');
      } catch (err) { 
        alert('Invalid JSON file'); 
      }
    };
    reader.readAsText(file);
  }

  function resetAll() {
    if (confirm('Warning: This will delete ALL your data permanently!')) {
      entries = [];
      baseValue = 16;
      streakData = { count: 0, lastDate: "" };
      milestones = {"5": false, "10": false, "20": false, "50": false};
      
      saveDataToCloud();
      render();
      openDailyModal();
    }
  }

  // Event Listeners
  document.getElementById('dailyInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') submitDaily();
  });
  
  document.getElementById('editInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') saveEdit();
  });

  // Input validation
  document.getElementById('dailyInput').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9.\-]/g, '');
    
    if (this.value.includes('-')) {
      const parts = this.value.split('-');
      if (parts.length > 2) {
        this.value = '-' + parts.slice(1).join('');
      }
      if (this.value.indexOf('-') > 0) {
        this.value = this.value.replace('-', '');
      }
    }
  });

  document.getElementById('editInput').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9.\-]/g, '');
    
    if (this.value.includes('-')) {
      const parts = this.value.split('-');
      if (parts.length > 2) {
        this.value = '-' + parts.slice(1).join('');
      }
      if (this.value.indexOf('-') > 0) {
        this.value = this.value.replace('-', '');
      }
    }
  });

  // Auto-check for new day
  setInterval(() => {
    const today = todayYMD();
    const hasToday = entries.some(e => e.date === today);
    if (!hasToday) {
      checkTodayPrompt();
    }
  }, 60000);

  // ================= FIREBASE AUTH STATE LISTENER =================
  // Check if user is already logged in
  auth.onAuthStateChanged((user) => {
    if (user) {
      // User is signed in
      loadApp(user);
    } else {
      // User is signed out
      document.getElementById('authContainer').style.display = 'flex';
      document.getElementById('appContainer').style.display = 'none';
    }
  });

  // Initialize auth forms
  showAuthTab('login');
</script>
</body>
</html>
